# Nginx 配置，用于Web页面伪装和流量分流

events {
    worker_connections 1024;
}

http {
    # 确保Nginx能够找到MIME类型
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server {
        # ⚠️ 监听端口修改为 8001，以接收 Cloudflared 的转发流量
        listen 8001;
        server_name _; # 匹配所有域名

        # 根路径 (/) 或任何其他非代理路径
        location / {
            # 1. 静态网页伪装：指定静态文件的根目录
            root /app/html;
            index index.html;
            
            # 尝试查找文件，如果找不到，返回404
            try_files $uri $uri/ =404;
        }

        # 代理路径：转发给 Xray 服务
        location /b3a053a4 {
            # 2. 流量分流：将请求转发到 Xray 监听的内部端口
            # ⚠️ Xray 监听端口修改为 8080
            proxy_pass http://127.0.0.1:8080; 
            
            # 必须设置 proxy_redirect off
            proxy_redirect off;
            
            # --------------------- WebSocket 关键配置 ---------------------
            # VLESS/VMess over WebSocket 需要 HTTP 1.1 和必要的头部
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # 传递原始的 Host 头部，对 Xray 区分域名流量至关重要
            proxy_set_header Host $http_host;
            # 阻止浏览器缓存代理响应
            proxy_set_header Cache-Control "no-cache, no-store, must-revalidate";
            proxy_buffering off;
        }
    }
}
